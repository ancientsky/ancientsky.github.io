<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>語音轉文字助手 (React Standalone)</title>
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 引入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 引入 Babel 用於解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Microsoft JhengHei, sans-serif;
        }
        /* 自定義捲軸樣式 */
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        textarea::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 圖示元件 (替代 lucide-react) ---
        const Mic = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
        );
        const MicOff = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="1" x2="23" y1="1" y2="23"/><path d="M9 9v3a3 3 0 0 0 5.12 2.12"/><line x1="12" x2="12" y1="19" y2="22"/><path d="M12 5a3 3 0 0 1 3 3v2"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg>
        );
        const Copy = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
        );
        const Check = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>
        );
        const Trash2 = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
        );
        const Globe = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
        );
        const AlertCircle = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
        );

        // --- 主應用程式 ---
        const SpeechToTextApp = () => {
            const [isListening, setIsListening] = useState(false);
            const [text, setText] = useState('');
            const [interimText, setInterimText] = useState('');
            const [language, setLanguage] = useState('zh-TW');
            const [error, setError] = useState('');
            const [isSupported, setIsSupported] = useState(true);
            const [copyFeedback, setCopyFeedback] = useState(false);

            const recognitionRef = useRef(null);
            const textAreaRef = useRef(null);

            useEffect(() => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                
                if (!SpeechRecognition) {
                    setIsSupported(false);
                    setError('您的瀏覽器不支援語音辨識功能，請使用 Google Chrome、Edge 或 Safari。');
                    return;
                }

                const recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = language;

                recognition.onstart = () => {
                    setIsListening(true);
                    setError('');
                };

                recognition.onresult = (event) => {
                    let finalTranscript = '';
                    let interimTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }

                    if (finalTranscript) {
                        setText(prev => prev + finalTranscript);
                    }
                    setInterimText(interimTranscript);
                };

                recognition.onerror = (event) => {
                    console.error("Speech recognition error", event.error);
                    if (event.error === 'not-allowed') {
                        setError('無法存取麥克風，請檢查瀏覽器權限設定。');
                        setIsListening(false);
                    } else if (event.error === 'no-speech') {
                        // 忽略
                    } else {
                        setError(`發生錯誤: ${event.error}`);
                        setIsListening(false);
                    }
                };

                recognition.onend = () => {
                    setIsListening(false);
                };

                recognitionRef.current = recognition;

                return () => {
                    if (recognitionRef.current) {
                        recognitionRef.current.stop();
                    }
                };
            }, [language]);

            useEffect(() => {
                if (recognitionRef.current) {
                    recognitionRef.current.lang = language;
                }
            }, [language]);

            const toggleListening = () => {
                if (isListening) {
                    recognitionRef.current.stop();
                } else {
                    setError('');
                    try {
                        recognitionRef.current.start();
                    } catch (e) {
                        console.error("Start error:", e);
                    }
                }
            };

            const handleCopy = () => {
                if (!text && !interimText) return;
                const fullText = text + interimText;
                
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(fullText).then(() => {
                        showCopyFeedback();
                    });
                } else {
                    const textArea = document.createElement("textarea");
                    textArea.value = fullText;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand("copy");
                    document.body.removeChild(textArea);
                    showCopyFeedback();
                }
            };

            const showCopyFeedback = () => {
                setCopyFeedback(true);
                setTimeout(() => setCopyFeedback(false), 2000);
            };

            const handleClear = () => {
                if (window.confirm('確定要清空所有文字嗎？')) {
                    setText('');
                    setInterimText('');
                }
            };

            if (!isSupported) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
                        <div className="bg-white p-8 rounded-xl shadow-lg max-w-md w-full text-center border-l-4 border-red-500">
                            <AlertCircle className="w-12 h-12 text-red-500 mx-auto mb-4" />
                            <h2 className="text-xl font-bold text-gray-800 mb-2">瀏覽器不支援</h2>
                            <p className="text-gray-600">{error}</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col items-center py-8 px-4 font-sans text-slate-800">
                    
                    {/* Header Section */}
                    <header className="w-full max-w-3xl mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div className="flex items-center gap-3">
                            <div className="bg-blue-600 p-2 rounded-lg">
                                <Mic className="w-6 h-6 text-white" />
                            </div>
                            <div>
                                <h1 className="text-2xl font-bold text-slate-800">語音轉文字助手</h1>
                                <p className="text-sm text-slate-500">使用 Chrome 內建核心 • 即時辨識</p>
                            </div>
                        </div>

                        <div className="flex items-center gap-3 bg-white p-1.5 rounded-full shadow-sm border border-slate-200">
                            <Globe className="w-4 h-4 text-slate-400 ml-2" />
                            <select 
                                value={language} 
                                onChange={(e) => {
                                    if (isListening) toggleListening();
                                    setLanguage(e.target.value);
                                }}
                                className="bg-transparent text-sm font-medium text-slate-700 outline-none cursor-pointer py-1 pr-2"
                            >
                                <option value="zh-TW">繁體中文 (台灣)</option>
                                <option value="en-US">English (US)</option>
                                <option value="zh-CN">简体中文</option>
                                <option value="ja-JP">日本語</option>
                            </select>
                        </div>
                    </header>

                    {/* Main Card */}
                    <main className="w-full max-w-3xl bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-100 flex flex-col h-[600px]">
                        
                        {/* Toolbar */}
                        <div className="border-b border-slate-100 p-4 flex justify-between items-center bg-slate-50/50">
                            <div className="flex items-center gap-2">
                                <span className={`flex h-3 w-3 rounded-full ${isListening ? 'bg-red-500 animate-pulse' : 'bg-slate-300'}`}></span>
                                <span className="text-sm font-medium text-slate-600">
                                    {isListening ? '正在聆聽中...' : '準備就緒'}
                                </span>
                                {error && <span className="text-xs text-red-500 ml-2 hidden sm:inline-block">{error}</span>}
                            </div>
                            
                            <div className="flex gap-2">
                                <button 
                                    onClick={handleCopy}
                                    className="flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-slate-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                                    title="複製文字"
                                >
                                    {copyFeedback ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
                                    {copyFeedback ? '已複製' : '複製'}
                                </button>
                                <button 
                                    onClick={handleClear}
                                    disabled={!text && !interimText}
                                    className="flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-slate-600 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                    title="清空內容"
                                >
                                    <Trash2 className="w-4 h-4" />
                                    清空
                                </button>
                            </div>
                        </div>

                        {/* Text Area Container */}
                        <div className="flex-1 p-6 overflow-hidden relative">
                            <textarea
                                ref={textAreaRef}
                                className="w-full h-full resize-none outline-none text-lg leading-relaxed text-slate-700 placeholder:text-slate-300 bg-transparent"
                                placeholder="點擊下方的麥克風按鈕，開始說話..."
                                value={text + (isListening ? interimText : '')}
                                onChange={(e) => setText(e.target.value)}
                            />
                            {isListening && interimText && (
                                <div className="absolute bottom-6 left-6 right-6 pointer-events-none">
                                    <p className="text-sm text-blue-500 font-medium animate-pulse">
                                        正在辨識: {interimText}
                                    </p>
                                </div>
                            )}
                        </div>

                        {/* Control Footer */}
                        <div className="p-6 border-t border-slate-100 flex justify-center items-center bg-slate-50">
                            <button
                                onClick={toggleListening}
                                className={`
                                    relative group flex items-center justify-center w-20 h-20 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 active:scale-95
                                    ${isListening 
                                        ? 'bg-red-500 hover:bg-red-600 shadow-red-200 ring-4 ring-red-100' 
                                        : 'bg-blue-600 hover:bg-blue-700 shadow-blue-200'
                                    }
                                `}
                            >
                                {isListening ? (
                                    <React.Fragment>
                                        <span className="absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-20 animate-ping"></span>
                                        <MicOff className="w-8 h-8 text-white relative z-10" />
                                    </React.Fragment>
                                ) : (
                                    <Mic className="w-8 h-8 text-white relative z-10" />
                                )}
                            </button>
                        </div>
                    </main>

                    <footer className="mt-8 text-center text-slate-400 text-sm">
                        <p>提示：請在安靜的環境下使用，並確保已允許瀏覽器使用麥克風權限。</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SpeechToTextApp />);
    </script>
</body>
</html>
